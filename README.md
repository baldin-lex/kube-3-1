# Домашнее задание к занятию «Компоненты Kubernetes» - Балдин

### Цель задания

Рассчитать требования к кластеру под проект

------

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания:

- [Considerations for large clusters](https://kubernetes.io/docs/setup/best-practices/cluster-large/),
- [Architecting Kubernetes clusters — choosing a worker node size](https://learnk8s.io/kubernetes-node-size).

------

### Задание. Необходимо определить требуемые ресурсы
Известно, что проекту нужны база данных, система кеширования, а само приложение состоит из бекенда и фронтенда. Опишите, какие ресурсы нужны, если известно:

1. Необходимо упаковать приложение в чарт для деплоя в разные окружения. 
2. База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
3. Кеш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
4. Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий. 
5. Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.

### Решение:

Для понимания подсчитаем суммарно вводные данные:

|Тип приложения|Количество копий|CPU|RAM (Гб)|
|---|---|---|---|
|DB|3|1*3=3|4*3=12|
|Cache|3|1*3=3|4*3=12|
|Frontend|5|0.2*5=1|0.05*5=0.25|
|Backend|10|1*10=10|0.6*10=6|
|ИТОГО||17|30.25|

Остановимся на конфигурации кластера, включающей 3 рабочие ноды, так как у нас есть требования по количеству реплик для БД и кэша. 
При этом усредненная нагрузка на одну ноду будет такой: 1 реплика DB, 1 реплика Cache, 3-4 реплики Backend и от 1 до 2 реплик Frontend. Что в расчете на ресурсы будет означать потребление подами: ~ 6-6.2 CPU и ~ 9.5 Гб RAM.  Округлим эти значения до 8 CPU и 10 Гб RAM.

Рассчитаем по [ЭТОЙ](https://learnk8s.io/kubernetes-node-size) статье резервирование ресурсов:

Резервирование CPU (в миллиядрах) 8000 - 60 (6% от 1 ядра) - 10 (1% от 2 ядра) - 10 (по 0.5% от 3 и 4 ядра) - 10 (по 0.25% от 5-8 ядер) = 7910 округлим до 7.9, что вполне покрывает потребность в 6.2 CPU.

Резервирование RAM (в Мб) 10000 - 1000 (по 25% от первых 4 Гб) - 800 (по 20% от 5-8 Гб) - 200 (по 10% от 9 и 10 Гб) - 100 (порог вытеснения) = 7900 т.е. 7.9 Гб. Этого недостаточно. Закладываем 16 Гб на ноду. 

Для отказоустойчивости желательно: 1 - вынести etcd на отдельные ноды, 2 - поднять три master-ноды и продублировать на них компоненты control plane, 3 - учесть вероятность выхода из строя 1 ноды (заложить +1 worker).
В итоге я предложил бы следующую конфигурацию:

|   |CPU|RAM|Количество нод|
|---|---|---|---|
|etcd|2|4GB|3|
|master|2|4GB|3|
|worker|8|16GB|3|

----

### Правила приёма работы

1. Домашняя работа оформляется в своем Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Сначала сделайте расчёт всех необходимых ресурсов.
3. Затем прикиньте количество рабочих нод, которые справятся с такой нагрузкой.
4. Добавьте к полученным цифрам запас, который учитывает выход из строя как минимум одной ноды. 
5. Добавьте служебные ресурсы к нодам. Помните, что для разных типов нод требовния к ресурсам разные. 
6. В результате должно быть указано количество нод и их параметры.
